<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>播放中心 - TS3AudioBot</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #4cc9f0;
            --success: #4ade80;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #0f172a;
            --dark-2: #1e293b;
            --light: #f8fafc;
            --muted: #94a3b8;
            --card: rgba(30, 41, 59, 0.85);
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
        }

        body.theme-dark {
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-2) 100%);
            color: var(--light);
            min-height: 100vh;
            font-family: "Manrope", "Microsoft YaHei", "PingFang SC", sans-serif;
        }

        .navbar {
            background: rgba(15, 23, 42, 0.95) !important;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(12px);
        }

        .navbar .nav-link {
            color: var(--muted);
            font-weight: 600;
        }

        .navbar .nav-link.active,
        .navbar .nav-link:hover {
            color: var(--accent);
        }

        .page-title {
            background: linear-gradient(to right, var(--accent), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-header {
            background: rgba(15, 23, 42, 0.6);
            border-bottom: 1px solid var(--border);
            color: var(--light);
        }

        .form-label {
            color: var(--muted);
            font-weight: 600;
        }

        .form-control,
        .form-select {
            background: rgba(15, 23, 42, 0.8);
            color: var(--light);
            border: 1px solid rgba(255, 255, 255, 0.22);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        .form-control::placeholder {
            color: rgba(148, 163, 184, 0.85);
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
            background: rgba(15, 23, 42, 0.9);
            color: var(--light);
        }

        .btn-primary {
            border: none;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }

        .btn-success {
            border: none;
            background: linear-gradient(to right, var(--success), #16a34a);
        }

        .btn-danger {
            border: none;
            background: linear-gradient(to right, var(--danger), #b5179e);
        }

        .btn-warning {
            border: none;
            background: linear-gradient(to right, var(--warning), #ea580c);
        }

        .btn-outline-light,
        .btn-outline-secondary {
            color: var(--light);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .btn-outline-light:hover,
        .btn-outline-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .queue-item {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 8px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .queue-item + .queue-item {
            margin-top: 8px;
        }

        .queue-item.active {
            border-left-color: var(--accent);
            background: rgba(67, 97, 238, 0.15);
        }

        .queue-item.playing {
            border-left-color: var(--success);
        }

        .song-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #f1f5f9;
        }

        .song-artist {
            color: rgba(248, 250, 252, 0.9);
            font-size: 0.85rem;
        }

        #current-song-title {
            color: #f8fafc;
            text-shadow: 0 1px 8px rgba(15, 23, 42, 0.55);
        }

        #current-song-artist {
            color: #e2e8f0 !important;
        }

        .queue-item .text-muted {
            color: rgba(248, 250, 252, 0.78) !important;
        }

        .mini-queue {
            max-height: 280px;
            overflow-y: auto;
        }

        .mini-queue .queue-item {
            padding: 10px 12px;
        }

        .album-art {
            width: 180px;
            height: 180px;
            border-radius: 12px;
            background: linear-gradient(45deg, #4361ee, #3a0ca3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .album-art i {
            font-size: 3.5rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .progress {
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            background: linear-gradient(to right, var(--accent), var(--primary));
        }

        .volume-control {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 12px 14px;
        }

        .volume-control.compact {
            min-width: 220px;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid transparent;
            box-shadow: none;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        @media (max-width: 992px) {
            .player-controls {
                flex-wrap: wrap;
            }
        }

        .time-volume-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .volume-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 220px;
        }

        .volume-inline .volume-range {
            width: 140px;
        }

        @media (max-width: 768px) {
            .time-volume-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .volume-inline {
                width: 100%;
            }

            .volume-inline .volume-range {
                width: 100%;
            }
        }

        .form-select option {
            background-color: #0f172a;
            color: #f8fafc;
        }

        .volume-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .volume-range {
            width: 100%;
            accent-color: var(--accent);
        }

        @media (max-width: 768px) {
            .volume-control.compact {
                width: 100%;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: var(--success);
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.4s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }

        .mode-active {
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.5);
            border-color: rgba(67, 97, 238, 0.6);
        }

        .text-muted {
            color: var(--muted) !important;
        }

        footer {
            color: var(--muted);
        }
    </style>
</head>
<body class="theme-dark" th:attr="data-mode=${bot != null ? bot.playbackMode().name().toLowerCase() : 'order'}">
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand fw-semibold" th:href="@{/}">TS3AudioBot</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="切换导航">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/}">机器人管理</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/player}">播放中心</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/settings}">设置</a>
                </li>
            </ul>
            <form method="post" action="/logout" class="d-flex">
                <button class="btn btn-outline-light btn-sm" type="submit">退出</button>
            </form>
        </div>
    </div>
</nav>

<main class="container py-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1 page-title">播放中心</h1>
            <p class="text-muted mb-0">创建、管理您的音乐播放队列，支持多种播放模式。</p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header fw-semibold"><i class="fas fa-robot"></i> 机器人选择</div>
                <div class="card-body">
                    <label class="form-label" for="botSelect">机器人</label>
                    <select id="botSelect" class="form-select">
                        <option value="">请选择</option>
                        <option th:each="b : ${bots}" th:value="${b.id()}" th:selected="${b.id() == botId}" th:text="${b.name()}">bot</option>
                    </select>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header fw-semibold"><i class="fas fa-list-ol"></i> 队列管理</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label" for="playlistSelect">播放列表</label>
                        <select id="playlistSelect" class="form-select">
                            <option th:each="playlist : ${playlists}"
                                    th:value="${playlist}"
                                    th:selected="${playlist == playlistId}"
                                    th:text="${playlist}">default</option>
                        </select>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button id="create-queue" class="btn btn-success" type="button">新建</button>
                        <button id="delete-queue" class="btn btn-danger" type="button">删除</button>
                        <button id="load-queue" class="btn btn-warning" type="button">查看</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="playlistName">新播放列表名称</label>
                        <input type="text" id="playlistName" class="form-control" placeholder="输入播放列表名称" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="song-url">添加歌曲 URL</label>
                        <div class="input-group">
                            <input type="text" id="song-url" class="form-control" placeholder="输入歌曲 URL...">
                            <button id="add-song" class="btn btn-success" type="button">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            
        </div>
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <span class="fw-semibold"><i class="fas fa-play-circle"></i> 当前播放</span>
                    <span class="text-muted"><span id="player-status" th:text="${bot != null ? bot.status() : '停止'}">已停止</span><span id="current-mode"> — 顺序播放</span></span>
                </div>
                <div class="card-body">
                    <div class="album-art" id="album-art">
                        <i class="fas fa-music"></i>
                    </div>
                    <div class="text-center">
                        <div class="h5 fw-bold" id="current-song-title"
                             th:text="${currentIndex >= 0 and queue.size() > currentIndex ? queue.get(currentIndex).track().title() : '未选择歌曲'}">未选择歌曲</div>
                        <div class="text-muted mb-3" id="current-song-artist"
                             th:text="${currentIndex >= 0 and queue.size() > currentIndex ? queue.get(currentIndex).track().sourceType() : '等待播放...'}">等待播放...</div>
                    </div>

                    <div class="mb-2">
                        <div class="progress" id="progress-bar" style="cursor: pointer;">
                            <div class="progress-bar" id="song-progress" style="width: 0%;"></div>
                        </div>
                        <div class="time-volume-row text-muted small mt-2">
                            <div class="d-flex gap-2">
                                <span id="current-time">0:00</span>
                                <span>/</span>
                                <span id="total-time" th:text="${currentIndex >= 0 and queue.size() > currentIndex ? (queue.get(currentIndex).track().durationMs() / 1000) + 's' : '0:00'}">0:00</span>
                            </div>
                            <div class="volume-inline">
                                <span><i class="fas fa-volume-up"></i></span>
                                <input id="volume-range" class="volume-range" type="range" min="0" max="100" step="1" value="100" />
                                <span id="volume-value">100%</span>
                            </div>
                        </div>
                    </div>

                    <div class="player-controls my-3">
                        <button id="prev-btn" class="btn btn-outline-light" type="button"><i class="fas fa-step-backward"></i></button>
                        <button id="play-pause-btn" class="btn btn-success" type="button"><i class="fas fa-play" id="play-icon"></i></button>
                        <button id="stop-btn" class="btn btn-warning" type="button"><i class="fas fa-stop"></i></button>
                        <button id="next-btn" class="btn btn-outline-light" type="button"><i class="fas fa-step-forward"></i></button>
                    </div>

                    <div class="d-flex flex-wrap gap-2 justify-content-center mb-3">
                        <button id="mode-order" class="btn btn-outline-light" type="button"><i class="fas fa-list"></i> 顺序播放</button>
                        <button id="mode-random" class="btn btn-outline-light" type="button"><i class="fas fa-random"></i> 随机播放</button>
                        <button id="mode-loop" class="btn btn-outline-light" type="button"><i class="fas fa-redo"></i> 单曲循环</button>
                    </div>

                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <span class="fw-semibold">当前列表</span>
                    <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#miniQueue" aria-expanded="true" aria-controls="miniQueue">
                        收起/展开
                    </button>
                </div>
                <div class="collapse show" id="miniQueue">
                    <div class="card-body mini-queue">
                        <div>
                            <div class="queue-item"
                                 th:each="item,iter : ${queue}"
                                 th:classappend="${iter.index == currentIndex ? ' active' : ''}"
                                 th:data-item-id="${item.id()}">
                                <div style="min-width: 0; flex: 1;">
                                    <div class="song-title" th:text="${item.track().title()}">Title</div>
                                    <div class="song-artist" th:text="${item.track().sourceType()}">source</div>
                                </div>
                                <button class="btn btn-danger btn-sm action-delete" type="button" title="Delete" data-bs-toggle="tooltip" data-bs-placement="top">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="text-muted text-center py-3" th:if="${#lists.isEmpty(queue)}">队列为空</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="border-top py-3 text-center text-muted small">TS3AudioBot Web 控制台</footer>

<div class="notification" id="notification"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const STORAGE_KEY = 'ts3ab.selectedBotId';
    const PLAYLIST_KEY_PREFIX = 'ts3ab.playlist.';

    const params = new URLSearchParams(window.location.search);
    const $botSelect = $('#botSelect');
    const $playlistSelect = $('#playlistSelect');
    const $notification = $('#notification');
    const $volumeRange = $('#volume-range');
    const $volumeValue = $('#volume-value');

    let volumeTimer = null;
    let volumeDragging = false;

    let playbackState = {
        status: '',
        playing: false,
        paused: false,
        positionMs: 0,
        durationMs: 0,
        volumePercent: 100,
        syncedAt: 0
    };

    function getBotId() {
        return new URLSearchParams(window.location.search).get('botId');
    }

    function getPlaylistId() {
        const value = $playlistSelect.val();
        return value && value.length ? value : 'default';
    }

    function persistPlaylist(botId, playlistId) {
        if (!botId || !playlistId) return;
        localStorage.setItem(PLAYLIST_KEY_PREFIX + botId, playlistId);
    }

    function redirectToPlayer(botId, playlistId) {
        if (!botId) return;
        const target = playlistId
            ? `/player?botId=${encodeURIComponent(botId)}&playlistId=${encodeURIComponent(playlistId)}`
            : `/player?botId=${encodeURIComponent(botId)}`;
        window.location.href = target;
    }

    function switchPlaylist() {
        const botId = getBotId();
        const playlistId = getPlaylistId();
        if (!botId || !playlistId) return;
        persistPlaylist(botId, playlistId);
        $.ajax({
            url: `/internal/queue/${botId}/playlists/${encodeURIComponent(playlistId)}/activate`,
            method: 'POST'
        }).done(() => redirectToPlayer(botId, playlistId))
            .fail(() => showNotification('切换失败', 'error'));
    }

    function createPlaylist() {
        const botId = getBotId();
        const name = $('#playlistName').val().trim();
        if (!botId || !name) return;
        $.ajax({
            url: `/internal/queue/${botId}/playlists`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name })
        }).done(() => {
            persistPlaylist(botId, name);
            $.ajax({
                url: `/internal/queue/${botId}/playlists/${encodeURIComponent(name)}/activate`,
                method: 'POST'
            }).done(() => redirectToPlayer(botId, name));
        }).fail(() => showNotification('创建失败', 'error'));
    }

    function deletePlaylist() {
        const botId = getBotId();
        const playlistId = getPlaylistId();
        if (!botId || !playlistId) return;
        if (playlistId === 'default') {
            showNotification('默认播放列表不可删除', 'warning');
            return;
        }
        $.ajax({
            url: `/internal/queue/${botId}/playlists/${encodeURIComponent(playlistId)}`,
            method: 'DELETE'
        }).done(() => {
            localStorage.removeItem(PLAYLIST_KEY_PREFIX + botId);
            redirectToPlayer(botId);
        }).fail(() => showNotification('删除失败', 'error'));
    }

    function addSong() {
        const botId = getBotId();
        const playlistId = getPlaylistId();
        const songUrl = $('#song-url').val().trim();
        if (!botId || !songUrl) return;
        persistPlaylist(botId, playlistId);
        $.ajax({
            url: `/internal/queue/${botId}/${encodeURIComponent(playlistId)}/add`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ query: songUrl, addedBy: 'web' })
        }).done(() => window.location.reload())
            .fail((resp) => {
                const text = resp && resp.responseText ? resp.responseText : '添加失败';
                showNotification(text, 'error');
            });
    }

    function control(action, reload = true) {
        const botId = getBotId();
        if (!botId) return;
        $.ajax({
            url: `/internal/bots/${botId}/${action}`,
            method: 'POST'
        }).done(() => {
            if (reload) {
                window.location.reload();
            }
        }).fail(() => showNotification('操作失败', 'error'));
    }

    function setMode(mode) {
        const botId = getBotId();
        if (!botId) return;
        $.ajax({
            url: `/internal/bots/${botId}/mode/${mode}`,
            method: 'POST'
        }).done(() => applyMode(mode, true))
            .fail(() => showNotification('模式切换失败', 'error'));
    }

    function applyMode(mode, notify) {
        const labels = {
            order: '顺序播放',
            random: '随机播放',
            loop: '单曲循环'
        };
        $('#mode-order').toggleClass('mode-active', mode === 'order');
        $('#mode-random').toggleClass('mode-active', mode === 'random');
        $('#mode-loop').toggleClass('mode-active', mode === 'loop');
        const $currentMode = $('#current-mode');
        if ($currentMode.length) {
            $currentMode.text(` — ${labels[mode] || labels.order}`);
        }
        if (notify) {
            showNotification(`模式：${labels[mode] || labels.order}`, 'success');
        }
    }

    function updatePlayPauseButton(isPlaying) {
        const $icon = $('#play-icon');
        if (!$icon.length) return;
        if (isPlaying) {
            $icon.removeClass('fa-play').addClass('fa-pause');
        } else {
            $icon.removeClass('fa-pause').addClass('fa-play');
        }
    }

    function updateStatusText(state) {
        const $status = $('#player-status');
        if (!$status.length) return;
        if (state.playing) {
            $status.text('PLAYING');
            return;
        }
        if (state.paused) {
            $status.text('PAUSED');
            return;
        }
        if (state.status) {
            $status.text(state.status);
        }
    }

    function clampVolume(value) {
        const safe = Number(value);
        if (Number.isNaN(safe)) {
            return 100;
        }
        return Math.max(0, Math.min(100, Math.round(safe)));
    }

    function updateVolumeDisplay(value) {
        const safe = clampVolume(value);
        if ($volumeRange.length) {
            $volumeRange.val(safe);
        }
        if ($volumeValue.length) {
            $volumeValue.text(`${safe}%`);
        }
    }

    function applyVolume(value) {
        const botId = getBotId();
        if (!botId) return;
        const safe = clampVolume(value);
        $.ajax({
            url: `/internal/bots/${botId}/volume`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ volumePercent: safe })
        }).fail(() => showNotification('音量调整失败', 'error'));
    }

    function scheduleVolumeUpdate(value) {
        if (volumeTimer) {
            clearTimeout(volumeTimer);
        }
        volumeTimer = setTimeout(() => applyVolume(value), 200);
    }

    function updateNowPlayingMeta(state) {
        if (state.title) {
            $('#current-song-title').text(state.title);
        }
        if (state.sourceType) {
            $('#current-song-artist').text(state.sourceType);
        }
    }

    function togglePlayPause() {
        const action = playbackState.playing ? 'stop' : 'start';
        control(action, false);
        setTimeout(syncPlaybackState, 400);
    }

    function showNotification(message, type = 'success') {
        if (!$notification.length) return;
        $notification.text(message);
        $notification.attr('class', `notification show ${type}`);
        setTimeout(() => $notification.removeClass('show'), 3000);
    }

    function formatTime(ms) {
        const safe = Math.max(0, Math.floor(ms / 1000));
        const minutes = Math.floor(safe / 60);
        const seconds = safe % 60;
        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateProgressFromState() {
        const duration = Math.max(0, playbackState.durationMs || 0);
        let position = Math.max(0, playbackState.positionMs || 0);
        if (playbackState.playing && playbackState.syncedAt) {
            position += Date.now() - playbackState.syncedAt;
        }
        if (duration > 0) {
            position = Math.min(position, duration);
        }
        const percent = duration > 0 ? (position / duration) * 100 : 0;
        $('#song-progress').css('width', `${percent}%`);
        $('#current-time').text(formatTime(position));
        $('#total-time').text(duration > 0 ? formatTime(duration) : '0:00');
    }

    function syncPlaybackState() {
        const botId = getBotId();
        if (!botId) return;
        $.getJSON(`/internal/bots/${botId}/playback`)
            .done((data) => {
                playbackState = {
                    status: data.status || '',
                    playing: Boolean(data.playing),
                    paused: Boolean(data.paused),
                    positionMs: Number(data.positionMs) || 0,
                    durationMs: Number(data.durationMs) || 0,
                    volumePercent: clampVolume(data.volumePercent),
                    syncedAt: Date.now()
                };
                updatePlayPauseButton(playbackState.playing);
                updateStatusText(playbackState);
                updateNowPlayingMeta(data);
                updateProgressFromState();
                if (!volumeDragging) {
                    updateVolumeDisplay(playbackState.volumePercent);
                }
            });
    }

    function seekPlayback(positionMs) {
        const botId = getBotId();
        if (!botId) return;
        $.ajax({
            url: `/internal/bots/${botId}/seek`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ positionMs })
        }).done(() => {
            playbackState.positionMs = positionMs;
            playbackState.syncedAt = Date.now();
            updateProgressFromState();
        }).fail(() => showNotification('跳转失败', 'error'));
    }

    function markPlaying(itemId) {
        $('.queue-item').removeClass('playing active');
        $('.queue-item').filter(function () {
            return $(this).data('item-id') === itemId;
        }).addClass('active playing');
    }

    function playNow(itemId) {
        const botId = getBotId();
        const playlistId = getPlaylistId();
        if (!botId || !itemId) return;
        persistPlaylist(botId, playlistId);
        $.ajax({
            url: `/internal/bots/${botId}/play/${encodeURIComponent(playlistId)}/${encodeURIComponent(itemId)}`,
            method: 'POST'
        }).done(() => {
            markPlaying(itemId);
            syncPlaybackState();
        }).fail(() => showNotification('播放失败', 'error'));
    }

    function deleteQueueItem(itemId) {
        const botId = getBotId();
        const playlistId = getPlaylistId();
        if (!botId || !itemId) return;
        $.ajax({
            url: `/internal/queue/${botId}/${encodeURIComponent(playlistId)}/items/${encodeURIComponent(itemId)}`,
            method: 'DELETE'
        }).done(() => window.location.reload())
            .fail(() => showNotification('删除失败', 'error'));
    }

    $(document).on('click', '.queue-item', function (event) {
        if ($(event.target).closest('.action-delete').length) {
            return;
        }
        const itemId = $(this).data('item-id');
        playNow(itemId);
    });

    $(document).on('click', '.action-delete', function (event) {
        event.preventDefault();
        event.stopPropagation();
        const itemId = $(this).closest('.queue-item').data('item-id');
        deleteQueueItem(itemId);
    });

    $('#progress-bar').on('click', function (event) {
        const duration = playbackState.durationMs || 0;
        if (duration <= 0) return;
        const $bar = $(this);
        const offset = $bar.offset();
        if (!offset) return;
        const ratio = Math.max(0, Math.min(1, (event.pageX - offset.left) / $bar.width()));
        seekPlayback(Math.round(duration * ratio));
    });

    $volumeRange.on('input', function () {
        volumeDragging = true;
        const value = clampVolume($(this).val());
        updateVolumeDisplay(value);
        scheduleVolumeUpdate(value);
    });

    $volumeRange.on('change', function () {
        volumeDragging = false;
        const value = clampVolume($(this).val());
        updateVolumeDisplay(value);
        applyVolume(value);
    });

    $(function () {
        const botId = params.get('botId');
        const playlistId = params.get('playlistId');
        $('[data-bs-toggle="tooltip"]').each(function () {
            new bootstrap.Tooltip(this);
        });
        if (!botId) {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const storedPlaylist = localStorage.getItem(PLAYLIST_KEY_PREFIX + stored);
                redirectToPlayer(stored, storedPlaylist);
                return;
            }
        } else {
            localStorage.setItem(STORAGE_KEY, botId);
        }
        if (botId && !playlistId) {
            const storedPlaylist = localStorage.getItem(PLAYLIST_KEY_PREFIX + botId);
            if (storedPlaylist) {
                redirectToPlayer(botId, storedPlaylist);
                return;
            }
        }
        $botSelect.on('change', () => {
            const selected = $botSelect.val();
            if (!selected) return;
            localStorage.setItem(STORAGE_KEY, selected);
            const storedPlaylist = localStorage.getItem(PLAYLIST_KEY_PREFIX + selected);
            redirectToPlayer(selected, storedPlaylist);
        });

        $('#create-queue').on('click', createPlaylist);
        $('#delete-queue').on('click', deletePlaylist);
        $('#load-queue').on('click', switchPlaylist);
        $('#add-song').on('click', addSong);

        $('#prev-btn').on('click', () => control('prev'));
        $('#stop-btn').on('click', () => control('stop'));
        $('#next-btn').on('click', () => control('next'));
        $('#play-pause-btn').on('click', togglePlayPause);

        $('#mode-order').on('click', () => setMode('order'));
        $('#mode-random').on('click', () => setMode('random'));
        $('#mode-loop').on('click', () => setMode('loop'));

        const initialMode = $('body').data('mode') || 'order';
        applyMode(initialMode, false);
        updateVolumeDisplay(playbackState.volumePercent);
        syncPlaybackState();
        setInterval(updateProgressFromState, 1000);
        setInterval(syncPlaybackState, 5000);
    });
</script>
</body>
</html>
